---
name: Issue and PR Triage

'on':
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue/PR number to triage (leave empty to process all)'
        required: false
        type: string

permissions:
  issues: write
  pull-requests: write
  actions: write
  contents: read
  models: read

jobs:
  triage-new-item:
    name: Triage New Issue or PR
    if: github.event_name == 'issues' || github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Get available labels
        id: get-labels
        uses: actions/github-script@v8
        with:
          script: |
            const labels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const labelNames = labels.data.map(label => label.name);
            return labelNames.join(', ');

      - name: Set environment variables
        env:
          ITEM_TITLE: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.title || github.event.issue.title }}
          ITEM_BODY: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.body || github.event.issue.body }}
          ITEM_TYPE: ${{ github.event_name == 'pull_request_target' && 'pull request' || 'issue' }}
          LABELS_RESULT: ${{ steps.get-labels.outputs.result }}
        run: |
          {
            echo "AVAILABLE_LABELS=${LABELS_RESULT}"
            echo "ITEM_TITLE=${ITEM_TITLE}"
            echo "ITEM_TYPE=${ITEM_TYPE}"
            echo "ITEM_BODY<<EOF"
            echo "${ITEM_BODY}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Analyze with AI
        id: ai-triage
        uses: actions/ai-inference@v2
        with:
          prompt: |
            ## Role

            You are an issue and pull request triage assistant. Analyze the current GitHub
            ${{ env.ITEM_TYPE }} and identify the most appropriate existing labels. Use the
            available tools to gather information; do not ask for information
            to be provided.

            ## Guidelines

            - Only use labels that are from the list of available labels.
            - You can choose multiple labels to apply.
            - When generating shell commands, you **MUST NOT** use command
              substitution with `$(...)`, `<(...)`, or `>(...)`. This is a
              security measure to prevent unintended command execution.

            ## Input Data

            **Available Labels** (comma-separated):
            ```
            ${{ env.AVAILABLE_LABELS }}
            ```

            **Title**:
            ```
            ${{ env.ITEM_TITLE }}
            ```

            **Body**:
            ```
            ${{ env.ITEM_BODY }}
            ```

            ## Steps

            1. Review the title, body, and available labels
               provided above.

            2. Based on the title and body, classify the ${{ env.ITEM_TYPE }}
               and choose all appropriate labels from the list of available
               labels.

            3. Return only the selected labels as a comma-separated list,
               with no additional text or explanation. For example:
               ```
               label1, label2, label3
               ```

      - name: Apply labels
        if: steps.ai-triage.outputs.response != ''
        uses: actions/github-script@v8
        env:
          AI_RESPONSE: ${{ steps.ai-triage.outputs.response }}
          AVAILABLE_LABELS: ${{ env.AVAILABLE_LABELS }}
        with:
          script: |
            const response = process.env.AI_RESPONSE;
            const availableLabelsStr = process.env.AVAILABLE_LABELS;

            if (!response || response.trim() === '') {
              console.log('No labels selected by AI');
              return;
            }

            // Parse available labels
            const availableLabels = availableLabelsStr.split(',')
              .map(l => l.trim())
              .filter(l => l.length > 0);

            // Parse AI suggested labels
            const suggestedLabels = response.replaceAll('```', '').split(',')
              .map(l => l.trim())
              .filter(l => l.length > 0);

            // Filter to only use labels that exist in the repository
            const validLabels = suggestedLabels.filter(label =>
              availableLabels.includes(label)
            );

            // Log any invalid labels
            const invalidLabels = suggestedLabels.filter(label =>
              !availableLabels.includes(label)
            );
            if (invalidLabels.length > 0) {
              console.log(
                `Skipping invalid labels: ${invalidLabels.join(', ')}`
              );
            }

            if (validLabels.length > 0) {
              console.log(`Applying labels: ${validLabels.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: validLabels
              });
            } else {
              console.log('No valid labels to apply');
            }

  triage-unlabeled-items:
    name: Triage Unlabeled Issues and PRs
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.issue_number == ''
    runs-on: ubuntu-latest
    steps:
      - name: Find and dispatch triage for unlabeled items
        uses: actions/github-script@v8
        with:
          script: |
            // Get all open issues (includes PRs)
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              }
            );

            console.log(`Found ${issues.length} open issues and PRs`);

            // Filter items without labels
            const unlabeledItems = issues.filter(issue =>
              issue.labels.length === 0
            );

            console.log(
              `Found ${unlabeledItems.length} unlabeled items`
            );

            if (unlabeledItems.length === 0) {
              console.log('No unlabeled items to process');
              return;
            }

            // Dispatch triage workflow for each unlabeled item
            for (const item of unlabeledItems) {
              const itemType = item.pull_request ? 'PR' : 'issue';
              console.log(
                `Dispatching triage for ${itemType} #${item.number}: ` +
                `"${item.title}"`
              );

              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'issue-triage.yml',
                  ref: context.ref || 'main',
                  inputs: {
                    issue_number: item.number.toString()
                  }
                });
              } catch (error) {
                console.error(
                  `Failed to dispatch triage for ${itemType} #${item.number}: ` +
                  `${error.message}`
                );
              }

              // Add a small delay to avoid rate limiting
              await new Promise(resolve => setTimeout(resolve, 100));
            }

            console.log('Finished dispatching triage workflows');

  triage-single-item:
    name: Triage Single Issue or PR
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.issue_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Get available labels
        id: get-labels
        uses: actions/github-script@v8
        with:
          script: |
            const labels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const labelNames = labels.data.map(label => label.name);
            return labelNames.join(', ');

      - name: Get item details
        id: get-item
        uses: actions/github-script@v8
        with:
          script: |
            const itemNumber = parseInt('${{ inputs.issue_number }}');

            // Try to get as an issue first (works for both issues and PRs)
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: itemNumber
            });

            const itemType = issue.data.pull_request ? 'pull request' : 'issue';

            return {
              title: issue.data.title,
              body: issue.data.body || '',
              type: itemType
            };

      - name: Set environment variables
        env:
          ITEM_TITLE: ${{ fromJSON(steps.get-item.outputs.result).title }}
          ITEM_BODY: ${{ fromJSON(steps.get-item.outputs.result).body }}
          ITEM_TYPE: ${{ fromJSON(steps.get-item.outputs.result).type }}
          LABELS_RESULT: ${{ steps.get-labels.outputs.result }}
        run: |
          {
            echo "AVAILABLE_LABELS=${LABELS_RESULT}"
            echo "ITEM_TITLE=${ITEM_TITLE}"
            echo "ITEM_TYPE=${ITEM_TYPE}"
            echo "ITEM_BODY<<EOF"
            echo "${ITEM_BODY}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Analyze with AI
        id: ai-triage
        uses: actions/ai-inference@v2
        with:
          prompt: |
            ## Role

            You are an issue and pull request triage assistant. Analyze the current GitHub
            ${{ env.ITEM_TYPE }} and identify the most appropriate existing labels. Use the
            available tools to gather information; do not ask for information
            to be provided.

            ## Guidelines

            - Only use labels that are from the list of available labels.
            - You can choose multiple labels to apply.
            - When generating shell commands, you **MUST NOT** use command
              substitution with `$(...)`, `<(...)`, or `>(...)`. This is a
              security measure to prevent unintended command execution.

            ## Input Data

            **Available Labels** (comma-separated):
            ```
            ${{ env.AVAILABLE_LABELS }}
            ```

            **Title**:
            ```
            ${{ env.ITEM_TITLE }}
            ```

            **Body**:
            ```
            ${{ env.ITEM_BODY }}
            ```

            ## Steps

            1. Review the title, body, and available labels
               provided above.

            2. Based on the title and body, classify the ${{ env.ITEM_TYPE }}
               and choose all appropriate labels from the list of available
               labels.

            3. Return only the selected labels as a comma-separated list,
               with no additional text or explanation. For example:
               ```
               label1, label2, label3
               ```

      - name: Apply labels
        if: steps.ai-triage.outputs.response != ''
        uses: actions/github-script@v8
        env:
          AI_RESPONSE: ${{ steps.ai-triage.outputs.response }}
          ITEM_NUMBER: ${{ inputs.issue_number }}
          AVAILABLE_LABELS: ${{ env.AVAILABLE_LABELS }}
        with:
          script: |
            const response = process.env.AI_RESPONSE;
            const itemNumber = parseInt(process.env.ITEM_NUMBER);
            const availableLabelsStr = process.env.AVAILABLE_LABELS;

            if (!response || response.trim() === '') {
              console.log('No labels selected by AI');
              return;
            }

            // Parse available labels
            const availableLabels = availableLabelsStr.split(',')
              .map(l => l.trim())
              .filter(l => l.length > 0);

            // Parse AI suggested labels
            const suggestedLabels = response.replaceAll('```', '').split(',')
              .map(l => l.trim())
              .filter(l => l.length > 0);

            // Filter to only use labels that exist in the repository
            const validLabels = suggestedLabels.filter(label =>
              availableLabels.includes(label)
            );

            // Log any invalid labels
            const invalidLabels = suggestedLabels.filter(label =>
              !availableLabels.includes(label)
            );
            if (invalidLabels.length > 0) {
              console.log(
                `Skipping invalid labels: ${invalidLabels.join(', ')}`
              );
            }

            if (validLabels.length > 0) {
              console.log(`Applying labels: ${validLabels.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: itemNumber,
                labels: validLabels
              });
            } else {
              console.log('No valid labels to apply');
            }
