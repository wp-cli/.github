---
name: Manage Repository Labels

'on':
  workflow_call:

permissions:
  issues: write
  contents: read

jobs:
  manage-labels:
    name: Create/Update Repository Labels
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'wp-cli' }}
    steps:
      - name: Check out source code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up PHP environment
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2
        with:
          php-version: 'latest'
        env:
          COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check existence of composer.json file
        id: check_composer_file
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v3
        with:
          files: "composer.json"

      - name: Get commands from composer.json
        id: get-commands
        if: steps.check_composer_file.outputs.files_exists == 'true'
        run: |
          # Extract commands from composer.json using composer config
          COMMANDS=$(composer config extra.commands 2>/dev/null || echo "[]")
          echo "commands=${COMMANDS}" >> "$GITHUB_OUTPUT"
          echo "Commands found: ${COMMANDS}"

      - name: Create/Update labels
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          COMMANDS_JSON: ${{ steps.get-commands.outputs.commands }}
        with:
          script: |
            // Standard labels that should exist in every repository
            const standardLabels = [
              { name: 'good-first-issue', color: '7057ff', description: 'Good for newcomers' },
              { name: 'help-wanted', color: '008672', description: 'Extra attention is needed' },
              { name: 'scope:documentation', color: 'FEF2C0', description: 'Related to documentation' },
              { name: 'scope:testing', color: 'FEF2C0', description: 'Related to testing' },
              { name: 'scope:distribution', color: '5B7E7E', description: 'Related to distribution' },
              { name: 'status:unconfirmed', color: 'BFE5BF', description: 'Issue was could not be confirmed yet' },
              { name: 'status:unsupported', color: 'BFE5BF', description: 'Ask is not supported' }
            ];

            // Parse commands from composer.json
            const commandsEnv = process.env.COMMANDS_JSON || '[]';
            let commands = [];
            
            try {
              commands = JSON.parse(commandsEnv);
              if (!Array.isArray(commands)) {
                commands = [];
              }
            } catch (e) {
              console.log('No commands found or invalid JSON format');
              commands = [];
            }

            // Generate command-specific labels
            const commandLabels = commands.map(command => {
              // Convert command to label format: replace spaces with dashes
              const labelName = 'command:' + command.replace(/\s+/g, '-');
              return {
                name: labelName,
                color: 'C5DEF5',
                description: `Related to '${command}' command`
              };
            });

            // Combine all labels
            const allLabels = [...standardLabels, ...commandLabels];

            console.log(`Creating/updating ${allLabels.length} labels...`);

            // Create or update each label
            for (const label of allLabels) {
              try {
                // Try to get existing label
                try {
                  await github.rest.issues.getLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name
                  });
                  
                  // Update if it exists
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`✓ Updated label: ${label.name}`);
                } catch (error) {
                  if (error.status === 404) {
                    // Create if it doesn't exist
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    console.log(`✓ Created label: ${label.name}`);
                  } else {
                    throw error;
                  }
                }
              } catch (error) {
                console.error(`✗ Failed to process label '${label.name}': ${error.message}`);
              }
            }

            console.log('Label management complete!');
